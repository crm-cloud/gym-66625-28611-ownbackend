# Fitverse Backend API

Self-hosted Node.js/Express/Prisma backend for Fitverse gym management system.

## Quick Start

### 1. Install Dependencies

```bash
npm install
```

### 2. Setup Database

1. Create a PostgreSQL database
2. Copy `.env.example` to `.env` and update `DATABASE_URL`
3. Run the schema from the root project:

```bash
psql -U your_user -d your_database -f ../database-schema.sql
```

### 3. Generate Prisma Client

```bash
npm run prisma:pull    # Introspect database schema
npm run prisma:generate # Generate Prisma Client
```

### 4. Start Development Server

```bash
npm run dev
```

The API will be available at `http://localhost:3001`

## Available Scripts

- `npm run dev` - Start development server with hot reload
- `npm run build` - Build for production
- `npm start` - Start production server
- `npm run prisma:pull` - Introspect database and update schema.prisma
- `npm run prisma:generate` - Generate Prisma Client
- `npm run prisma:studio` - Open Prisma Studio (database GUI)

## Environment Variables

See `.env.example` for all available configuration options.

### Required Variables

```bash
DATABASE_URL="postgresql://..."
JWT_SECRET="your-secret"
JWT_REFRESH_SECRET="your-refresh-secret"
```

### Optional Variables

- Email service configuration (SES, SendGrid, or SMTP)
- AWS S3 for file storage
- Stripe for payments
- CORS origins
- Rate limiting

## Project Structure

```
backend/
├── src/
│   ├── server.ts              # Express app entry point
│   ├── config/
│   │   └── database.ts        # Prisma client
│   ├── middleware/
│   │   ├── errorHandler.ts   # Global error handling
│   │   ├── logger.ts          # Request logging
│   │   ├── auth.ts            # JWT authentication (Phase 3)
│   │   └── authorize.ts       # Role-based access (Phase 5)
│   ├── routes/                # API route handlers (Phase 4)
│   ├── controllers/           # Business logic (Phase 4)
│   ├── services/              # Data access layer (Phase 4)
│   ├── utils/                 # Utility functions
│   └── types/                 # TypeScript types
├── prisma/
│   └── schema.prisma          # Generated by prisma db pull
├── .env                       # Environment variables
└── package.json
```

## API Endpoints

### Health Check

```
GET /health
```

Response:
```json
{
  "status": "healthy",
  "timestamp": "2024-01-15T12:00:00Z",
  "uptime": 123.45,
  "environment": "development"
}
```

### Coming in Phase 3-6

- `POST /api/auth/login` - User authentication
- `GET /api/members` - List members
- `GET /api/branches` - List branches
- `GET /api/trainers` - List trainers
- ... and 50+ more endpoints

## Database Schema

The backend uses the existing `database-schema.sql` from the root project. This includes:

- 40+ tables (members, branches, trainers, classes, etc.)
- Row Level Security (RLS) policies (replaced by API middleware)
- Triggers and functions
- Views and indexes

## Authentication Flow

### Phase 3 (Not yet implemented)

1. User sends credentials to `POST /api/auth/login`
2. Backend validates credentials with bcrypt
3. Backend generates JWT access token (15min) and refresh token (7 days)
4. Frontend stores tokens and includes in `Authorization: Bearer <token>` header
5. Protected routes validate JWT using middleware

## Deployment

### Backend (Render/Railway/AWS)

1. Push code to GitHub
2. Connect to deployment platform
3. Set environment variables
4. Deploy

### Database

1. Provision PostgreSQL database
2. Run `database-schema.sql`
3. Update `DATABASE_URL` in production environment

## Security

- JWT tokens for authentication
- bcrypt for password hashing
- Helmet for HTTP security headers
- Rate limiting to prevent abuse
- CORS configuration
- Input validation with Zod
- SQL injection prevention via Prisma

## Development

### Adding a New Endpoint

1. Create route handler in `src/routes/`
2. Create controller in `src/controllers/`
3. Create service in `src/services/` (Prisma queries)
4. Add validation schemas
5. Register route in `src/server.ts`

Example:
```typescript
// src/routes/member.routes.ts
import { Router } from 'express';
import { authenticate } from '@/middleware/auth';
import { authorize } from '@/middleware/authorize';
import { getMembersController } from '@/controllers/member.controller';

const router = Router();

router.get('/', 
  authenticate, 
  authorize(['admin', 'manager']), 
  getMembersController
);

export default router;
```

## Troubleshooting

### Prisma Issues

**Problem**: Prisma Client is out of sync

**Solution**:
```bash
npm run prisma:pull
npm run prisma:generate
```

### Database Connection

**Problem**: Cannot connect to database

**Solution**: 
1. Check `DATABASE_URL` in `.env`
2. Verify PostgreSQL is running
3. Check firewall/network settings
4. Test connection: `psql $DATABASE_URL`

### CORS Errors

**Problem**: Frontend cannot access API

**Solution**: Add frontend URL to `ALLOWED_ORIGINS` in `.env`:
```bash
ALLOWED_ORIGINS="http://localhost:5173,https://yourdomain.com"
```

## Next Steps

See `MIGRATION_PLAN.md` in the root project for the full migration roadmap.

**Current Status**: ✅ Phase 1 Complete (Backend Foundation)

**Next**: Phase 2 - Database Setup & Prisma Introspection
